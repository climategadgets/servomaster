<project name="ServoMaster" default="servomaster" basedir=".">

    <!-- $Id: build.xml,v 1.18 2002-09-20 02:32:14 vtt Exp $ -->

    <property name="project" value="servomaster"/>

    <!--
    
      Give user a chance to override without editing this file
      (and without typing -D each time he compiles it)
      
      -->
    
    <property file=".${project}.properties"/>
    <property file="${user.home}/.${project}.properties"/>
    
    <!--
        =======================================================================
        
        Below is a list of properties you can safely override from the
        property files (above)
        
      -->
      
    <!-- Do we want the debug? -->
    <property name="DEBUG" value="true"/>
    
    <!--
        =======================================================================
        
        Below is a stuff you don't want to be messing with. It has been left
        undocumented on purpose: if you know what you're doing, it's
        self-explanatory, if you don't, you don't have anything to do with
        it anyway.
        
      -->
    <property name="version" value="0.1"/>
    
    <!--
    
        Ant 1.5 breaks the build if the compiler type is not supported
        
      -->
    <property name="build.compiler" value="modern"/>
    <property name="javac.depend" value="false"/>
    <property name="javac.deprecation" value="true"/>
    
    <property name="build.dir" value="../build/classes"/>
    <property name="src.java.dir" value="../src/java"/>
    <property name="dist.dir" value="../build/${project}-${version}"/>
    <property name="javadoc.dir" value="../docs/apidocs"/>
    
    <property name="phidget.enabled.${phidget.enabled}" value="true"/>
    
    <!--
    
        Build target list.
        
        For all the targets, the source files are copied to the separate
        directory before the build commences, because it might be required
        to modify the files to adjust for whatever reason; to name a few,
        
            - Target system configuration
            - Optional packages
            - Configure time switches
        
      -->
    
    <!--
    
        Targets without external dependencies.
        
      -->
      
    <property name="model.build.src" value="../build/src/model"/>
    <property name="ft639.build.src" value="../build/src/ft639"/>
    <property name="phidget.build.src" value="../build/src/phidget"/>
    <property name="view.build.src" value="../build/src/view"/>
    <property name="view_ft639.build.src" value="../build/src/view_ft639"/>
    <property name="view_phidget.build.src" value="../build/src/view_phidget"/>
    <property name="test.build.src" value="../build/src/test"/>

    <!--
    
        The default target.
         
        Contains all other targets as dependencies.
         
        Please pay attention to the fact that some of the dependencies may
        not be executed if they are conditional targets. That's intended.
         
      -->
    
    <target name="servomaster" depends="prepare,
                                        model,
                                        ft639,
                                        phidget,
                                        view,
                                        view_ft639,
                                        view_phidget,
                                        test,
                                        test_phidget">
    
        <mkdir dir="${build.dir}/META-INF"/>
        
        <copy file="../COPYING" tofile="${build.dir}/META-INF/LICENSE"/>
        
        <jar jarfile="./${project}.jar"
             basedir="${build.dir}"
             manifest="../etc/manifest"/>
        
    </target>
    
    <target name="check_modules">
    
        <!-- Check if we're working with JDK 1.3 -->
          
        <available classname="java.lang.StrictMath" property="jdk1.3"/>
        
        <!-- Check if we have JavaCOMM available -->
        
        <available classname="javax.comm.SerialPort" property="JavaCOMM.present"/>
        
        <!-- Check if jUSB is available -->
        
        <available classname="usb.core.Bus" classpath="${JUSB.jar}" property="jUSB.present"/>
    
    </target>
    
    <target name="prepare" depends="check_modules">

        <mkdir dir="${build.dir}"/>
        
        <echo>
        
            Will be installed to: ${prefix}
            Phidget enabled:      ${phidget.enabled}

        </echo>

    </target>
    
    <target name="model" depends="prepare">
    
        <copy todir="${model.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="device/model/Meta.java"/>
                <include name="device/model/Servo.java"/>
                <include name="device/model/ServoMetaData.java"/>
                <include name="device/model/ServoListener.java"/>
                <include name="device/model/ServoController.java"/>
                <include name="device/model/ServoControllerMetaData.java"/>
                <include name="device/model/ServoControllerListener.java"/>
                <include name="device/model/AbstractServo.java"/>
                <include name="device/model/AbstractServoController.java"/>
                <include name="device/model/DisconnectListener.java"/>
                <include name="device/model/TransitionController.java"/>
                <include name="device/model/TransitionToken.java"/>
                <include name="device/model/SilentDevice.java"/>
                <include name="device/model/ProblemListener.java"/>

                <include name="device/model/silencer/SilentHelper.java"/>
                <include name="device/model/silencer/SilentProxy.java"/>

                <include name="device/model/transform/AbstractCoordinateTransformer.java"/>
                <include name="device/model/transform/Reverser.java"/>
                <include name="device/model/transform/SineTransformer.java"/>
                <include name="device/model/transform/CosineTransformer.java"/>
                <include name="device/model/transform/ScaleTransformer.java"/>
                <include name="device/model/transform/LinearTransformer.java"/>

                <include name="device/model/transition/CrawlTransitionController.java"/>
                
            </fileset>

        </copy>

        <javac depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${model.build.src}" destdir="${build.dir}"/>

    </target>
    
    <target name="JavaCOMM_check" unless="JavaCOMM.present">
    
        <fail message="JavaCOMM extension is not present"/>
        
    </target>
    
    <target name="JavaCOMM_enable" depends="JavaCOMM_check">
    
        <echo message="JavaCOMM verified"/>
    
    </target>
    
    <target name="jUSB_check" unless="jUSB.present" if="phidget.enabled.true">
    
        <fail message="jUSB was not found in '${JUSB.jar}'"/>
        
    </target>
    
    <target name="jUSB_enable" depends="jUSB_check" if="phidget.enabled.true">
    
        <echo message="jUSB verified"/>
    
    </target>
    
    <!--
    
        The classes pertinent to FerretTronics FT639
        
      -->

    <target name="ft639" depends="model,JavaCOMM_enable">
    
        <copy todir="${ft639.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="device/impl/ft/FT639Constants.java"/>
                <include name="device/impl/ft/FT639ServoController.java"/>
                
            </fileset>
            
        </copy>
    
        <javac depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${ft639.build.src}" destdir="${build.dir}"/>

    </target>

    <!--
    
        The classes pertinent to Phidget controller
        
      -->
    
    <target name="phidget" depends="model,jUSB_enable" if="phidget.enabled.true">
    
        <copy todir="${phidget.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="device/impl/phidget/Firmware.java"/>
                <include name="device/impl/phidget/firmware/Servo8.java"/>
                <include name="device/impl/phidget/PhidgetServoController.java"/>
                
            </fileset>
            
        </copy>
    
        <javac depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${phidget.build.src}" destdir="${build.dir}">
            <classpath>
                <pathelement path="${JUSB.jar}"/>
            </classpath>
        </javac>
        
    </target>

    <!--
    
        The view
        
      -->

    <target name="view" depends="model,ft639">
    
        <copy todir="${view.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="view/Console.java"/>
                <include name="view/ServoView.java"/>
                <include name="view/ServoControllerView.java"/>
                <include name="view/SilencerPanel.java"/>
                <include name="device/impl/ft/FT639ServoControllerView.java"/>
                
            </fileset>
            
        </copy>
    
        <javac depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${view.build.src}" destdir="${build.dir}"/>

    </target>
    
    <target name="view_ft639" depends="view,ft639">
    
        <copy todir="${view_ft639.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="device/impl/ft/FT639ServoControllerView.java"/>
                
            </fileset>
            
        </copy>
    
        <javac depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${view_ft639.build.src}" destdir="${build.dir}"/>

    </target>

    <target name="view_phidget" depends="view,phidget" if="phidget.enabled.true">
    
        <copy todir="${view_phidget.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="device/impl/phidget/PhidgetServoControllerView.java"/>
                
            </fileset>
            
        </copy>
    
        <javac depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${view_phidget.build.src}" destdir="${build.dir}"/>

    </target>
    
    <target name="test" depends="model">
    
        <copy todir="${test.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="test/integration/SyncCheck.java"/>
                
            </fileset>
            
        </copy>
    
        <javac depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${test.build.src}" destdir="${build.dir}">
            <classpath>
                <pathelement path="${JUSB.jar}"/>
            </classpath>
        </javac>

    </target>

    <target name="test_phidget" depends="model,jUSB_enable" if="phidget.enabled.true">
    
        <copy todir="${test.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="test/USB_Map.java"/>
                
            </fileset>
            
        </copy>
    
        <javac depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${test.build.src}" destdir="${build.dir}">
            <classpath>
                <pathelement path="${JUSB.jar}"/>
            </classpath>
        </javac>

    </target>

    <target name="dist">

        <mkdir dir="${dist.dir}"/>

    </target>

    <target name="clean">
    
        
    </target>
    
    <target name="distclean" depends="clean">

        <deltree dir="${dist.dir}"/> 

    </target>
    
    <target name="dist-copy-sources">
    
        <copy todir="../${project}-${version}/src/java">
        
            <fileset dir="../src/java">
            
                <include name="**/*.java"/>
                <include name="**/package.html"/>
                <include name="**/*.properties"/>

            </fileset>
            
        </copy>
        
    </target>
    
    <target name="javadocs">
    
        <mkdir dir="${javadoc.dir}"/>

        <javadoc packagenames="org.freehold.*"
                 sourcepath="${src.java.dir}"
                 destdir="${javadoc.dir}"
                 version="true"
                 use="true"
                 author="true"
                 private="true"
                 windowtitle="ServoMaster ${version} API">
                
            <group title="Model" packages="org.freehold.servomaster.device.model*"/>
            <group title="FT639 Driver" packages="org.freehold.servomaster.device.impl.ft"/>
            <group title="PhidgetServo Driver" packages="org.freehold.servomaster.device.impl.phidget"/>
            <group title="View" packages="org.freehold.servomaster.view"/>
            <group title="Tests" packages="org.freehold.servomaster.test*"/>
            
            <classpath>
                <pathelement path="${JUSB.jar}"/>
            </classpath>

        </javadoc>
    
        
    </target>
    
</project>
