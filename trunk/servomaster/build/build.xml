<project name="ServoMaster" default="servomaster" basedir=".">

    <!-- $Id: build.xml,v 1.30 2005-01-13 23:14:25 vtt Exp $ -->

    <property name="project" value="servomaster"/>

    <!--
    
      Give user a chance to override without editing this file
      (and without typing -D each time he compiles it)
      
      -->
    
    <property file=".${project}.properties"/>
    <property file="${user.home}/.${project}.properties"/>
    
    <!--
        =======================================================================
        
        Below is a list of properties you can safely override from the
        property files (above)
        
      -->
      
    <!-- Do we want the debug? -->
    <property name="DEBUG" value="true"/>
    
    <!--
        =======================================================================
        
        Below is a stuff you don't want to be messing with. It has been left
        undocumented on purpose: if you know what you're doing, it's
        self-explanatory, if you don't, you don't have anything to do with
        it anyway.
        
      -->
    <property name="version" value="0.1"/>
    
    <!--
    
        Ant 1.5 breaks the build if the compiler type is not supported
        
      -->
    <property name="build.compiler" value="modern"/>
    <property name="javac.depend" value="false"/>
    <property name="javac.deprecation" value="true"/>
    <property name="javac.debug" value="true"/>
    
    <property name="build.dir" value="../build/classes"/>
    <property name="src.java.dir" value="../src/java"/>
    <property name="dist.dir" value="../build/${project}-${version}"/>
    <property name="javadoc.dir" value="../docs/apidocs"/>
    
    <property name="javax-usb.jar" value="../lib/jsr80.jar"/>
    
    <property name="serial.enabled.${serial.enabled}" value="true"/>
    <property name="usb.enabled.${usb.enabled}" value="true"/>
    
    <!--
    
        Build target list.
        
        For all the targets, the source files are copied to the separate
        directory before the build commences, because it might be required
        to modify the files to adjust for whatever reason; to name a few,
        
            - Target system configuration
            - Optional packages
            - Configure time switches
        
      -->
    
    <!--
    
        Targets without external dependencies.
        
      -->
      
    <property name="model.build.src" value="../build/src/model"/>
    <property name="serial.build.src" value="../build/src/serial"/>
    <property name="ft639.build.src" value="../build/src/ft639"/>
    <property name="seetron.build.src" value="../build/src/seetron"/>
    <property name="usb.build.src" value="../build/src/usb"/>
    <property name="phidget.build.src" value="../build/src/phidget"/>
    <property name="pololu.build.src" value="../build/src/pololu"/>
    <property name="view.build.src" value="../build/src/view"/>
    <property name="view_ft639.build.src" value="../build/src/view_ft639"/>
    <property name="view_phidget.build.src" value="../build/src/view_phidget"/>
    <property name="view_pololu.build.src" value="../build/src/view_pololu"/>
    <property name="test.build.src" value="../build/src/test"/>

    <!--
    
        The default target.
         
        Contains all other targets as dependencies.
         
        Please pay attention to the fact that some of the dependencies may
        not be executed if they are conditional targets. That's intended.
         
      -->
    
    <target name="servomaster" depends="prepare,
                                        model,
                                        ft639,
                                        phidget,
                                        pololu,
                                        view,
                                        view_ft639,
                                        view_phidget,
                                        test,
                                        test_phidget">
    
        <mkdir dir="${build.dir}/META-INF"/>
        
        <copy file="../COPYING" tofile="${build.dir}/META-INF/LICENSE"/>
        
        <jar jarfile="./${project}-${version}.jar"
             basedir="${build.dir}"
             manifest="../etc/manifest"/>
        
    </target>
    
    <target name="check_modules">
    
        <!-- Check if we're working with JDK 1.3 -->
          
        <available classname="java.lang.StrictMath" property="jdk1.3"/>
        
        <!-- Check if we have JavaCOMM available -->
        
        <available classname="javax.comm.SerialPort" property="JavaCOMM.present"/>
    
    </target>
    
    <target name="prepare" depends="check_modules">

        <mkdir dir="${build.dir}"/>
        
        <echo>
        
            Will be installed to: ${prefix}
            Serial enabled:       ${serial.enabled}
            USB enabled:          ${usb.enabled}

        </echo>

    </target>
    
    <target name="model" depends="prepare">
    
        <copy todir="${model.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="device/model/Meta.java"/>
                <include name="device/model/AbstractMeta.java"/>
                <include name="device/model/Servo.java"/>
                <include name="device/model/ServoListener.java"/>
                <include name="device/model/ServoController.java"/>
                <include name="device/model/ServoControllerListener.java"/>
                <include name="device/model/AbstractServo.java"/>
                <include name="device/model/AbstractServoController.java"/>
                <include name="device/model/DisconnectListener.java"/>
                <include name="device/model/TransitionController.java"/>
                <include name="device/model/TransitionToken.java"/>
                <include name="device/model/SilentDevice.java"/>
                <include name="device/model/ProblemListener.java"/>

                <include name="device/model/silencer/SilentHelper.java"/>
                <include name="device/model/silencer/SilentProxy.java"/>

                <include name="device/model/transform/AbstractCoordinateTransformer.java"/>
                <include name="device/model/transform/Reverser.java"/>
                <include name="device/model/transform/SineTransformer.java"/>
                <include name="device/model/transform/CosineTransformer.java"/>
                <include name="device/model/transform/ScaleTransformer.java"/>
                <include name="device/model/transform/LinearTransformer.java"/>

                <include name="device/model/transition/CrawlTransitionController.java"/>
                
                <include name="util/ImmutableIterator.java"/>
                <include name="util/dec2hex.java"/>
                
            </fileset>

        </copy>

        <javac debug="${javac.debug}" depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${model.build.src}" destdir="${build.dir}"/>

    </target>
    
    <target name="JavaCOMM_check" if="serial.enabled.true" unless="JavaCOMM.present">
    
        <fail message="JavaCOMM extension is not present"/>
        
    </target>
    
    <target name="JavaCOMM_enable" depends="JavaCOMM_check" if="serial.enabled.true">
    
        <echo message="JavaCOMM verified"/>
    
    </target>
    
    <!--
    
        Serial controller abstractions
        
      -->
    
    <target name="serial" depends="model,JavaCOMM_enable" if="serial.enabled.true">
    
        <copy todir="${serial.build.src}/org/freehold/servomaster/device/impl/serial">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster/device/impl/serial">
            
                <include name="AbstractSerialServoController.java"/>
                
            </fileset>
            
        </copy>
    
        <javac debug="${javac.debug}" depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${serial.build.src}" destdir="${build.dir}"/>

    </target>

    <!--
    
        The classes pertinent to FerretTronics FT639
        
      -->

    <target name="ft639" depends="serial,JavaCOMM_enable" if="serial.enabled.true">
    
        <copy todir="${ft639.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="device/impl/ft/FT639Constants.java"/>
                <include name="device/impl/ft/FT639ServoController.java"/>
                
            </fileset>
            
        </copy>
    
        <javac debug="${javac.debug}" depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${ft639.build.src}" destdir="${build.dir}"/>

    </target>
    
    <!--
        
        USB abstractions
        
      -->

    <target name="usb" depends="model" if="usb.enabled.true">
    
        <copy todir="${usb.build.src}/org/freehold/servomaster/device/impl/usb">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster/device/impl/usb">
            
                <include name="AbstractUsbServoController.java"/>
                
            </fileset>

        </copy>
        
        <javac debug="${javac.debug}" depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${usb.build.src}" destdir="${build.dir}">
            <classpath>
                <pathelement path="${javax-usb.jar}"/>
            </classpath>
        </javac>

    </target>

    <!--
    
        The classes pertinent to Phidget controllers
        
      -->
    
    <target name="phidget" depends="model,usb" if="usb.enabled.true">
    
        <copy todir="${phidget.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="device/impl/phidget/Firmware.java"/>
                <include name="device/impl/phidget/firmware/Servo8.java"/>
                <include name="device/impl/phidget/PhidgetServoController.java"/>
                <include name="device/impl/phidget/QuadServoController.java"/>
                
            </fileset>
            
        </copy>
    
        <javac debug="${javac.debug}" depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${phidget.build.src}" destdir="${build.dir}">
            <classpath>
                <pathelement path="${javax-usb.jar}"/>
            </classpath>
        </javac>
        
    </target>

    <!--
    
        The classes pertinent to Pololu controllers
        
      -->
    
    <target name="pololu" depends="model,usb" if="usb.enabled.true">
    
        <copy todir="${pololu.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="device/impl/pololu/USB16ServoController.java"/>
                <include name="device/impl/pololu/PacketBuilder.java"/>
                
            </fileset>
            
        </copy>
    
        <javac debug="${javac.debug}" depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${pololu.build.src}" destdir="${build.dir}">
            <classpath>
                <pathelement path="${javax-usb.jar}"/>
            </classpath>
        </javac>
        
    </target>

    <!--
    
        The view
        
      -->

    <target name="view" depends="model">
    
        <copy todir="${view.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="view/Console.java"/>
                <include name="view/ServoView.java"/>
                <include name="view/ServoControllerView.java"/>
                <include name="view/SilencerPanel.java"/>
                
            </fileset>
            
        </copy>
    
        <javac debug="${javac.debug}" depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${view.build.src}" destdir="${build.dir}"/>

    </target>
    
    <target name="view_ft639" depends="view,ft639" if="serial.enabled.true">
    
        <copy todir="${view_ft639.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="device/impl/ft/FT639ServoControllerView.java"/>
                
            </fileset>
            
        </copy>
    
        <javac debug="${javac.debug}" depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${view_ft639.build.src}" destdir="${build.dir}"/>

    </target>

    <target name="view_phidget" depends="view,phidget" if="usb.enabled.true">
    
        <copy todir="${view_phidget.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="device/impl/phidget/PhidgetServoControllerView.java"/>
                <include name="device/impl/phidget/QuadServoControllerView.java"/>
                
            </fileset>
            
        </copy>
    
        <javac debug="${javac.debug}" depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${view_phidget.build.src}" destdir="${build.dir}">
            <classpath>
                <pathelement path="${javax-usb.jar}"/>
            </classpath>
        </javac>
    </target>
    
    <target name="test" depends="model">
    
        <copy todir="${test.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="test/integration/SyncCheck.java"/>
                
            </fileset>
            
        </copy>
    
        <javac debug="${javac.debug}" depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${test.build.src}" destdir="${build.dir}">
            <classpath>
                <pathelement path="${javax-usb.jar}"/>
            </classpath>
        </javac>

    </target>

    <target name="test_phidget" depends="model" if="usb.enabled.true">
    
        <!--
    
        <copy todir="${test.build.src}/org/freehold/servomaster">
        
            <fileset dir="${src.java.dir}/org/freehold/servomaster">
            
                <include name="test/USB_Map.java"/>
                
            </fileset>
            
        </copy>
    
        <javac debug="${javac.debug}" depend="${javac.depend}" deprecation="${javac.deprecation}" srcdir="${test.build.src}" destdir="${build.dir}">
            <classpath>
                <pathelement path="${javax-usb.jar}"/>
            </classpath>
        </javac>
          -->

    </target>

    <target name="dist">

        <mkdir dir="${dist.dir}"/>

    </target>

    <target name="clean">
    
        
    </target>
    
    <target name="distclean" depends="clean">

        <deltree dir="${dist.dir}"/> 

    </target>
    
    <target name="dist-copy-sources">
    
        <copy todir="../${project}-${version}/src/java">
        
            <fileset dir="../src/java">
            
                <include name="**/*.java"/>
                <include name="**/package.html"/>
                <include name="**/*.properties"/>

            </fileset>
            
        </copy>
        
    </target>
    
    <target name="javadocs">
    
        <mkdir dir="${javadoc.dir}"/>

        <javadoc packagenames="org.freehold.*"
                 sourcepath="${src.java.dir}"
                 destdir="${javadoc.dir}"
                 version="true"
                 use="true"
                 author="true"
                 private="true"
                 windowtitle="ServoMaster ${version} API">
                
            <group title="Model" packages="org.freehold.servomaster.device.model*"/>
            <group title="FT639 Driver" packages="org.freehold.servomaster.device.impl.ft"/>
            <group title="PhidgetServo Driver" packages="org.freehold.servomaster.device.impl.phidget"/>
            <group title="View" packages="org.freehold.servomaster.view"/>
            <group title="Tests" packages="org.freehold.servomaster.test*"/>
            
            <classpath>
                <pathelement path="${javax-usb.jar}"/>
            </classpath>

        </javadoc>
    
        
    </target>
    
</project>
